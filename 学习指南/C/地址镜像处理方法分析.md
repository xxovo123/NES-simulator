# **地址镜像处理方法深度解析**

在存储系统（如 NES 游戏机）中，由于地址线连接方式的特性，某些物理内存块会重复映射到多个连续的地址范围内，这种现象被称为**镜像（Mirroring）**。代码中分别使用了**位与运算 (&)** 和 **取模运算 (%)** 来还原物理地址。

## **1\. 位与运算方法 (&)**

### **代码片段**

// CPU RAM 范围: $0000 \- $1FFF (8KB)  
// 实际物理 RAM 只有 2KB ($0000 \- $07FF)  
return bus-\>ram\[addr & 0x07FF\];

### **原理解析**

位与运算通过\*\*位掩码（Bitmask）\*\*保留地址的低位，直接丢弃高位。

* **0x07FF** 的二进制是 0000 0111 1111 1111（共 11 个 1）。  
* 它可以覆盖的范围是 ![][image1] 到 ![][image2]（即 ![][image1] 到 ![][image3]）。  
* 当地址为 0x0801 (2049) 时：  
  0x0801 & 0x07FF ![][image4] 0000 1000 0000 0001 & 0000 0111 1111 1111 \= 0000 0000 0000 0001 (1)。  
  这成功地将第 2049 个字节映射回了物理 RAM 的第 1 个字节。

### **优点**

1. **极速性能**：在 CPU 层面，位运算通常只需要一个时钟周期，且不涉及除法器。  
2. **实现简单**：直接屏蔽高位地址线。

### **局限性**

* **必须是 2 的幂**：此方法仅适用于物理内存大小恰好为 ![][image5] 的情况（如 2KB, 4KB, 8KB 等）。

## **2\. 取模运算方法 (%)**

### **代码片段**

// 处理 PRG-ROM 镜像  
// offset 是相对于 $8000 的偏移量  
// prg\_size\_bytes 可能是 16KB 或 32KB  
return bus-\>cartridge-\>prg\_rom\[offset % prg\_size\_bytes\];

### **原理解析**

取模运算通过计算余数来确保索引永远不会超出数组边界，并形成循环映射。

* 如果 prg\_size\_bytes 是 16KB (16384 字节)。  
* 当访问 16385 字节处时：16385 % 16384 \= 1。  
* 这使得逻辑上连续的地址空间能够循环访问有限的物理 ROM 空间。

### **优点**

1. **高度通用**：适用于任何数值的大小，不要求必须是 ![][image6] 的幂。  
2. **逻辑直观**：非常符合“循环映射”的数学定义。

### **局限性**

* **性能开销**：在大多数处理器架构中，取模运算（通常依赖除法指令）比位运算慢得多（可能耗费几十个时钟周期）。

## **3\. 两种方法的对比汇总**

| 特性 | 位与运算 (&) | 取模运算 (%) |
| :---- | :---- | :---- |
| **核心逻辑** | 屏蔽高位地址线 (Masking) | 计算余数 (Remainder) |
| **性能** | **极快** (单周期) | **较慢** (涉及除法) |
| **限制条件** | 目标大小必须是 ![][image5] | 目标大小可以是任意正整数 |
| **硬件隐喻** | 对应物理电路中不连接高位地址线 | 对应更复杂的逻辑转换 |
| **典型应用** | 内部 RAM (![][image6]KB), PPU 寄存器 (![][image7] 字节) | 卡带 Mapper, 非标准大小的 ROM |

## **4\. 为什么代码中不统一使用一种方法？**

### **为什么 RAM 用 &？**

NES 的内部 RAM 镜像是因为 CPU 地址线 A11、A12 没有连接到 RAM 芯片的使能引脚上。在模拟器中，这是高频操作（每条指令可能多次读写 RAM），使用位运算可以显著提升模拟速度。且 2KB 恰好是 ![][image6] 的幂，完美契合 & 0x07FF。

### **为什么 ROM 用 %？**

NES 的 PRG-ROM 大小取决于卡带。

* 虽然标准 NROM 是 16KB 或 32KB（都是 2 的幂），但有些特殊的 Mapper 或自制软件可能使用非标准的大小。  
* 使用取模运算提供了更好的**鲁棒性**。即使 prg\_size\_bytes 发生变化，逻辑依然成立。  
* ROM 读取频率相对 RAM 略低（部分通过缓存优化），因此在此处牺牲极小性能换取代码的可维护性是可以接受的。

**总结建议**：在已知存储大小为 2 的幂次方且追求极致性能的情况下，优先选择**位与运算**；在处理动态大小或非 2 的幂次方存储映射时，使用**取模运算**。

[image1]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAWCAYAAAD5Jg1dAAAA3klEQVR4XmNgGNFARUWFT05OboK8vPw7IH0SiK3R1TAoKSnxAxXsAeI5MjIynLKysm5A9msg7YeiUEFBIQIo8QloijFUiBHIng8UOwEyBKaIAyiwFYgfArEkTDNQYTmQ/xtI24AFQJJQRaeBgoJoCv8DcRFMwBjI+QrEB0RFRXmQFPqCFAJtXEg7hUpAgedAfFhdXZ0XphCoIB2kEORWmEJBkEfksfv6PxAHwcRAPp8EMhVkOj4xkKChPCTqYkB8ZWVlMSD/CpA/AchlhCuEAWlpaWGQJ4CxoYZVwcAAAGi+RqhBZojtAAAAAElFTkSuQmCC>

[image2]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAAXCAYAAABaiVzAAAABqUlEQVR4Xu2XP0vDUBTFW1RwEPxbpE1p/mw6iBAQXMTVwUXBxS8hXQQHv4Crk+igm5O4O4hO4ldQsKA4Owg6iP5um0C5vFdTKTGlOXBo7rn3vdzDy0teC4UcOQYDYRiOuK5bTqr3HTAxB/fgQ61W21U5o96XKJVKY57nTcBTbcimZxI0OU+zN6zMt9D3/RXkoq6zGbLpaYMeLuG61pvA1BLJO5pdJBwiXhCzxDu61mbIpqcB6Rue0/OL9G00SsEoyQt4VqlUZmKd+B0+Q1/VGw3Z9DRQrVYd7r/qOM601SirN0vyMXpk67HO9a1pkM2QTU8bpp5jDJM8hB/tBcTXkfnt9mKbIZueNjoZNYIBT/ATLkfxmpjh9w024InX2tNNkyb9P/AXo7KaR3IQ0Lksoyuj7Fvq3asgCMZ1LutIbFTMiUneZFM61yvIoy1PS1J2sxUSGY3OqzL5sc71EnKf6G1fTsJuts+vRmUyCvYpPIgn5roON3RtltHRKMlN+CVFiq8MCnR9hlGMjG7phD4waN4zaFKPyRroMXRbJzndv3zu+v+vY44cA4Af4dWjDujKuC8AAAAASUVORK5CYII=>

[image3]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAXCAYAAACI2VaYAAACpElEQVR4Xu2VTYiNURjH3wlFlMJ1m/t17oeUKItLYiwshrJgQ0kkC8XaZGZng2x9FZmRJBuyQiyEWKgZ2fnYkmymm5qyQA2/f/ec1zPnzr3m2tF96t8553+e55z/c97nnDdJetaznv1jViqVBsrl8rhz7if4DkZjn3q9vgB+CN+PtJ/AS8XFftZY8xh+TzOZzJLAqS8OvABXLfA/D8rpAmwwyMTDfD5fYDiP/k7wpVKpuNQpSfrwOwf/pFAoLPNxAxIKthq/1PBbhf9n8MyKY9wPPrjmQcRQ0pWwwCIG98HpbDa7OCzAhiNwl+j2aVwsFtcxbtDuDj6ag7uF7yOtY/hwytfAtIvEkfR6uAniDoG9Aoe1H+4V7b50EWeywGlX4BGxEe5NLpdbobEX+5W2ngb/5htgjeWVBHOX2ex5LE5fCgxbf3z2gItKKiX9yd0Fk8oo8BLhRfcn/oQ6iJuRWK1WW4mo2xIsYbE49szbZFRjjO/5svqzKXMCHhC30BewNpmyCciMuBFPqTZP6vOYuBniYsP/Ctge87OajlaZh/oym4STTC0WR9wmxqNaY67idGpxzbY11/z+PxJ/GboRR/8m/bVRXFtxEmVOvbPp+cDegqHAdSnueJibizjmNhM7GPMtVq1Wl7pmnR1O/KnJVHfiXYcLgc9RWmV2pOSfB3CQ8XtBfXy2ETLfxjN3Jl6zxfTG4ThmhdG/EZ4S5i50EDet7P2tsy++bvg3MMn8ddoTSjTE+j0fu+hrWNPtGnatL7UwFpy45svLzd/bKcWIowSyjN9ZzpqeBtd88V8rPp73j/GUaydOE67NryTUUTBu7wZtBn+W9oAXe0flYP1MrcVrxr8xvYMNJWnj/9r0KRC5QzWFqNXJLCfWhelx3xKTPfuv7RerTvLbG9n5SwAAAABJRU5ErkJggg==>

[image4]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAYCAYAAAAYl8YPAAAAsElEQVR4XmNgGAWjYBSQAJSUlNTk5eWL0cXJAlJSUiIKCgoL5eTkBNHlyAKKioryQMM2gmh0ObIA0CAzoIE7gK5UgAsC2RzAMCgF4llk4ANA/AuIa4FGscAMFAAKSJKCZWRkVIH0ViCerKKiwgd3HanA2NiYFWQI0BEJQC4jujxJQFZW1g9oUCcDpQYBvccJDPgFIG+iy5EMgN7TBBo2nQEW4JQAUHiJi4tzo4uPIAAA7O4pgOcYJ4MAAAAASUVORK5CYII=>

[image5]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAVCAYAAABPPm7SAAABT0lEQVR4XmNgGAVDCIiKivKAMIitoKDAoaysLAZkMsMVyMnJWQMlTsnLy/8H4l9APFtaWloGJKeoqKgP5PcB8QmgmkYgXQ1UXwekt8I0uwA526EamIFsTyB+DxS/BZIHskughpwHGhAOFdMEWcggIyPDCeRsAeIWcXFxbiQXlYNcA2QygpwsKytrCuQfl5KSEgHJA/l+QP5+kEmSQPwQpBioyRdmAFTDN5gGoCHpQP4aIJMFZCiQPQUo1gBTjwGgNvwH2Q4yBGj4SSDfEiQHCkCQ7UCxdnR9YGBsbMwK1LgKqOgvVIhRXV2dF0Qjq0H2MgoAagwG4t9AG8rQ5QgCYGgD9cpfA+JiBiQbiQJKSkr8QI1bgc5PYCBVM8g/QM1zkDUDvSAIiwW8ABQgQM2T0W2WhyQWDoRK7IARFFigKMOG0RVjAHmkhIQNo6unOgAAJEZWhHrqfV4AAAAASUVORK5CYII=>

[image6]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAWCAYAAAD5Jg1dAAAA6UlEQVR4XmNgGNFATk5OS0FB4ZC8vPx/ID6uqKhoBxRmRFEEFDQDKjwJVGgA5DIDFZ4HaQDyC+CKgBwOoOB6IF4kJSUlAhIDajIG8r8C8RMgVoSZJg7k3IVaWQQSU1dX5wWyD4PEgJp8YYayAAWmAPEPmKCoqCgPkH8AqjkaphADADXEQBXNMjY2ZkWXhwOgwltARXuUlJT40eXgACQJVLhTRkZGCF0ODkDWgKwDKuJEl4MDkCKgSXVAhd0wMVAoAHEQsjpGoEApSCGS40GhMU9WVtYUrgooEAzEf6E+RcbPgZqV4AoHOQAAAGk6B+rLd+sAAAAASUVORK5CYII=>

[image7]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAXCAYAAAA2jw7FAAABFElEQVR4XmNgGFlASUlJTU5O7qC8vPxTIP0ISJfKyMhwgiUVFRWBfPmtQFoPxAdJAPlzgAqngxUAGeUgjDAPLKYEVHQBzFFQUFgIxJ1AJiNMAVBSkngFQMYkIP4LNLbM2NiYFSrmCMT7YAoMgfg9EP8H4j1A0zyAik8CHW0GMxGkKAiIf0EV/QPibAYkK5mBOvKBgqeB+ApU0X+QlTDdxUC8GxhY/KAwAErUQRX9BQWSOJBxEWQvzDgQkJWVdQOKfwUFiDFQ8pK0tLQMsgIgYATKzQcZrwnEt0EK0RSA5Fph4b4ZiGfBwgAEgKYqAMWOgDkg4+UhPjgPxMmgUAXSD4DYG24cSDfQYSZAq0JADgT5CCQOAHuMSzPiQnlKAAAAAElFTkSuQmCC>