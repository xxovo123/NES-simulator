# MOS 6502 CPU 寻址方式技术汇总

MOS 6502 处理器以其精简的指令集和高效的寻址方式著称。它共拥有 **13 种** 标准寻址方式，这些方式决定了 CPU 如何确定操作数在内存中的位置。

## 1. 寻址方式分类详解

### 1.1 隐含寻址 (Implied - IMP)

指令不包含显式的操作数地址，操作对象已隐含在指令本身中，通常操作 CPU 内部寄存器。

- **汇编语法：** `CLC`, `DEX`, `INX`  
- **说明：** 不需要额外的操作数读取。

### 1.2 累加器寻址 (Accumulator - ACC)

指令直接对累加器 $A$ 进行操作。

- **汇编语法：** `ASL A`, `ROR A`  
- **说明：** 指令长度为 1 字节。

### 1.3 立即寻址 (Immediate - IMM)

操作数直接包含在指令中（紧跟在操作码之后的 8 位常数）。

- **汇编语法：** `LDA #$10`  
- **说明：** 使用 `#` 符号标识。

### 1.4 零页寻址 (Zero Page - ZP0)

仅使用 8 位地址来访问内存的前 256 字节（`$0000` - `$00FF`）。

- **汇编语法：** `LDA $10`  
- **说明：** 比绝对寻址快 1 个时钟周期，且节省 1 字节空间。

### 1.5 零页 X 变址寻址 (Zero Page, X - ZPX)

将 8 位基础地址与 X 寄存器的值相加，计算结果限制在零页内。

- **逻辑：** $Address = (Base + X) \pmod{256}$  
- **汇编语法：** `LDA $10, X`  
- **说明：** 如果相加结果超过 255，会发生“回卷”（Wrap-around）。

### 1.6 零页 Y 变址寻址 (Zero Page, Y - ZPY)

与零页 X 类似，但使用 Y 寄存器。

- **汇编语法：** `LDX $10, Y`  
- **说明：** 仅少数指令支持（如 `LDX`, `STX`）。

### 1.7 绝对寻址 (Absolute - ABS)

使用 16 位地址访问内存中的任意位置。

- **汇编语法：** `LDA $1234`  
- **说明：** 在内存中以小端序（Little-Endian）存储：低位字节在前，高位字节在后。

### 1.8 绝对 X 变址寻址 (Absolute, X - ABX)

将 16 位基础地址与 X 寄存器的值相加得出最终地址。

- **逻辑：** $Address = Base + X$  
- **汇编语法：** `LDA $1234, X`  
- **周期补偿：** 如果计算导致页面跨越（Page Boundary Cross），需增加 1 个周期。

### 1.9 绝对 Y 变址寻址 (Absolute, Y - ABY)

与绝对 X 类似，但使用 Y 寄存器。

- **汇编语法：** `LDA $1234, Y`  
- **周期补偿：** 同样存在页面跨越的补偿逻辑。

### 1.10 相对寻址 (Relative - REL)

用于条件分支指令。操作数是一个 8 位有符号偏移量（$-128$ 到 $+127$）。

- **逻辑：** $Target = PC + 2 + Offset$  
- **汇编语法：** `BEQ label`  
- **说明：** 实际地址相对于当前 PC 计算。

### 1.11 间接寻址 (Indirect - IND)

仅用于 `JMP` 指令。操作数是一个 16 位地址，该地址存储的内容才是真正的目标地址。

- **汇编语法：** `JMP ($1234)`  
- **硬件 Bug：** 如果地址低位为 `$FF`（如 `$01FF`），读取高位地址时不会跨页，而是错误地读取 `$0100`（6502 已知缺陷）。

### 1.12 间接 X 变址寻址 (Indexed Indirect, X - IZX)

先将零页地址与 X 相加，然后从零页获取 16 位目标地址。

- **逻辑：** $Target = \text{Memory}[(Base + X) \bmod 256]$  
- **汇编语法：** `LDA ($10, X)`  
- **常用于：** 处理存储在零页中的指针表。

### 1.13 间接 Y 变址寻址 (Indirect Indexed, Y - IZY)

先从零页获取一个 16 位指针，再将 Y 的值加到该指针上。

- **逻辑：** $Target = \text{Memory}[Base] + Y$  
- **汇编语法：** `LDA ($10), Y`  
- **重要性：** 6502 最强大的寻址方式，用于遍历数组或处理动态内存。同样存在页面跨越周期补偿。

## 2. 寻址方式快速参考表

| **模式名称**     | **缩写** | **汇编示例**   | **长度(字节)** | **基础周期** | **页面跨越补偿** |
| ---------------- | -------- | -------------- | -------------- | ------------ | ---------------- |
| **Immediate**    | IMM      | `LDA #$10`     | 2              | 2            | 否               |
| **Zero Page**    | ZP0      | `LDA $10`      | 2              | 3            | 否               |
| **Zero Page, X** | ZPX      | `LDA $10, X`   | 2              | 4            | 否               |
| **Absolute**     | ABS      | `LDA $1234`    | 3              | 4            | 否               |
| **Absolute, X**  | ABX      | `LDA $1234, X` | 3              | 4            | **是 (+1)**      |
| **Absolute, Y**  | ABY      | `LDA $1234, Y` | 3              | 4            | **是 (+1)**      |
| **Indirect**     | IND      | `JMP ($1234)`  | 3              | 5            | 否               |
| **Indirect, X**  | IZX      | `LDA ($10, X)` | 2              | 6            | 否               |
| **Indirect, Y**  | IZY      | `LDA ($10), Y` | 2              | 5            | **是 (+1)**      |
| **Relative**     | REL      | `BEQ $05`      | 2              | 2            | **是 (+1/+2)**   |

> **注：**  
> - 页面大小 = 256 字节（`$0100`）  
> - 相对寻址跨越页面时，部分分支指令可能增加 1 或 2 周期（取决于具体实现）  
> - 表格未列出 IMP/ACC 模式（无操作数，长度 1 字节，周期依指令而定）

## 3. 模拟器开发关键要点

1. **字节序处理**  
   6502 采用小端序（Little-Endian）：  
   ```c
   uint16_t addr = memory[pc] | (memory[pc+1] << 8); // 低位在前
   ```

2. **页面跨越检测**  
   页面边界 = 256 字节对齐（`$xx00`）：  
   ```c
   if ((final_addr & 0xFF00) != (base_addr & 0xFF00)) {
       cycles++; // 需增加额外周期
   }
   ```

3. **零页地址回卷**  
   在 `ZPX`/`ZPY`/`IZX` 模式下，地址计算必须限制在零页内：  
   ```c
   uint8_t zp_addr = (base + reg) & 0xFF; // 强制回卷至 $00-$FF
   ```

4. **间接寻址硬件缺陷**  
   `JMP ($xxFF)` 会错误读取 `$xx00` 而非 `$ (xx+1)00`，模拟时需特殊处理：
   ```c
   if ((addr & 0x00FF) == 0x00FF) {
       // 6502 bug: 高位地址不跨页
       high_byte_addr = (addr & 0xFF00) | 0x0000;
   }
   ```

> ✅ **最佳实践**：在模拟器中为每种寻址模式编写独立解析函数，并显式处理边界条件与周期补偿逻辑。